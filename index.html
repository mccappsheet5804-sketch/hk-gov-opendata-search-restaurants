<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK Government OpenData - Restaurant Search</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.min.css" />
    <link rel="stylesheet" href="index.css" />
</head>

<body>
    <div id="map"></div>
    <div class="control-panel mb-2">
        <button class="btn btn-success" id="refreshCurrentLocationByGPS">更新「我的位置」</button>
        <hr />
        <button class="btn btn-success" id="drawRectBtn">選擇「範圍」</button>
        <button class="btn btn-danger" id="clearBtn" hidden>清除「範圍」</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
    <script>
        window.__gv__ = { GPS: null };

        const initOnLoad = async () => {
            // Initialize map
            const map = L.map('map', { zoomControl: false })

            L.control.zoom({ position: 'bottomleft' }).addTo(map);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Prepare container for drawn items
            const drawnItems = new L.FeatureGroup();
            const userItem = new L.FeatureGroup();
            map.addLayer(drawnItems);
            map.addLayer(userItem);

            window.__gv__.GPS = await getCurrentLocationByGPS();

            // Get current location using GPS
            async function getCurrentLocationByGPS() {
                if (!navigator.geolocation) {
                    throw new Error("Geolocation is not supported by this browser.");
                }

                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            window.__gv__.GPS = position.coords;
                            const [lat, lng] = [window.__gv__.GPS.latitude, window.__gv__.GPS.longitude];
                            map.setView([window.__gv__.GPS.latitude, window.__gv__.GPS.longitude], 17);
                            // Create a custom icon
                            const userIcon = L.icon({
                                iconUrl: `https://img.icons8.com/?size=100&id=OZZ2pTwn45ie&format=png&color=000000`,
                                iconSize: [40, 40], // Size of the icon [width, height]
                                iconAnchor: [20, 0], // Point of the icon which will correspond to marker's location
                            });

                            // Create the marker with the custom icon
                            map.removeControl(userItem);
                            const marker = L.marker([lat, lng], { icon: userIcon }).addTo(userItem);
                            map.addLayer(userItem);
                            resolve(position.coords);
                        },
                        (error) => {
                            console.error(`Error getting location: ${error.message}`);
                            reject(new Error("Could not get your location. Please allow location access."));
                        }
                    );
                });
            }

            // Function to initialize drawing controls
            function initDraw() {
                const drawControl = new L.Control.Draw({
                    draw: {
                        rectangle: true,
                        polygon: false,
                        polyline: false,
                        circle: false,
                        marker: false,
                        circlemarker: false
                    }
                });

                // Get user location
                document.getElementById('refreshCurrentLocationByGPS').addEventListener(
                    'click',
                    async () => {
                        window.__gv__.GPS = await getCurrentLocationByGPS();
                    }
                );

                // Toggle drawing mode
                document.getElementById('drawRectBtn').addEventListener('click', () => {
                    map.addControl(drawControl);
                });

                // Handle drawn items
                map.on('draw:created', async (e) => {
                    const layer = e.layer;
                    drawnItems.addLayer(layer);
                    document.getElementById('clearBtn').hidden = false;
                    document.getElementById('clearBtn').disabled = true;
                    document.getElementById('drawRectBtn').hidden = true;

                    // Retrieve rectangle corners
                    const _northEast = layer.getBounds().getNorthEast();
                    const _southWest = layer.getBounds().getSouthWest();

                    const url = `https://portal.csdi.gov.hk/server/services/common/fehd_rcd_1630036390312_58893/MapServer/WFSServer?service=wfs&request=GetFeature&typenames=FEHD_RL&outputFormat=geojson&maxFeatures=100&srsName=EPSG:4326&filter=<Filter><Intersects><PropertyName>SHAPE</PropertyName><gml:Envelope srsName='EPSG:4326'><gml:lowerCorner>${_southWest.lat} ${_southWest.lng}</gml:lowerCorner><gml:upperCorner>${_northEast.lat} ${_northEast.lng}</gml:upperCorner></gml:Envelope></Intersects></Filter>`;

                    const response = await fetch(url);
                    const jdata = await response.json();

                    // Plot the markers on the map
                    jdata.features.forEach(plotMarker);

                    document.getElementById('clearBtn').disabled = false;
                });

                // Clear button functionality
                document.getElementById('clearBtn').addEventListener('click', () => {
                    drawnItems.clearLayers();
                    document.getElementById('drawRectBtn').hidden = false;
                    document.getElementById('clearBtn').hidden = true;
                    map.removeControl(drawControl);
                });
            }

            // Function to plot markers
            function plotMarker(feature) {
                const coords = feature.geometry.coordinates;
                const lat = coords[1]; // Latitude
                const lng = coords[0]; // Longitude

                const marker = L.marker([lat, lng]).addTo(drawnItems);
                const properties = feature.properties;

                // Prepare content for the popup
                const GetItem = (en, tc) => en !== tc ? `${tc} / ${en}` : en;
                const popupContent = `
                <small class="text-success fst-italic fw-bold">更新日期時間：${properties.NSEARCH05_EN}</small>
                <div class="d-flex flex-column mt-3">
                    <div>
                        <b>商店名稱：</b>${GetItem(properties.NSEARCH03_EN, properties.NSEARCH03_TC)}
                    </div>
                    <div class="d-flex justify-content-center align-items-center">
                        <hr class="w-75"/>
                    </div>
                    <b>地址：</b>
                    <ul>
                        <li>${properties.ADDRESS_TC}</li>
                        <li>${properties.ADDRESS_EN}</li>
                    </ul>
                    <b>牌照：</b>
                    <ul>
                        <li>${properties.DATASET_EN} (${properties.DATASET_TC})</li>
                        <li>${properties.NAME_EN} (${properties.NAME_TC})</li>
                    </ul>
                </div>
            `;

                // Bind the popup to the marker
                marker.bindPopup(popupContent);
                marker.on('click', () => { marker.openPopup(); });
            }

            // Load Leaflet.draw script and initialize
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.min.js';
            script.onload = initDraw;
            script.onerror = () => {
                console.error('Failed to load Leaflet.draw script.');
            };
            document.body.appendChild(script);
        };

        initOnLoad();
    </script>
</body>

</html>